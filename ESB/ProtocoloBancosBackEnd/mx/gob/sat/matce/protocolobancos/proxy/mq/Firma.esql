BROKER SCHEMA mx.gob.sat.matce.protocolobancos.proxy.mq
PATH mx.gob.sat.matce;

/*
*
* Autor: Oscar Daniel Jiménez Gutiérrez - Softtek
* Fecha de creación: Enero 2018 Version: 1.0
*/


CREATE COMPUTE MODULE Firma_GetDetalleTransaccion
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		SET Environment.XMLValidator.SchemaLocation = SchemaLocation;
		DECLARE refEnv REFERENCE TO Environment;
		DECLARE refIn REFERENCE TO InputRoot;		
		CALL InitializeFlowProxyMQ(refEnv, refIn);
		
		SET OutputRoot.XMLNSC = InputRoot.XMLNSC;
		DELETE FIELD OutputRoot.XMLNSC.[1].DetalleTransaccion;
		
		IF InputRoot.MQMD.SourceQueue = 'PB.FIRMA.VALIDAR.REQ' THEN
			SET OutputLocalEnvironment.Destination.SOAP.Request.Operation = 'validateXmlSign';
		ELSE
			SET OutputLocalEnvironment.Destination.SOAP.Request.Operation = 'firmarXml';
		END IF;
	END;
END MODULE;

CREATE COMPUTE MODULE Firma_FaultException
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		SET Environment.actor = 'WL';
		IF InputLocalEnvironment.Destination.SOAP.Request.Operation = 'validateXmlSign' THEN
			THROW USER EXCEPTION MESSAGE(2) VALUES('Error al validar firma del mensaje (fault)');
		ELSE
			THROW USER EXCEPTION MESSAGE(4) VALUES('Error al firmar el mensaje (fault)');
		END IF;
		RETURN FALSE;
	END;
END MODULE;


CREATE COMPUTE MODULE Firma_GenerarRespuestaMQ
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		SET Environment.actor = 'WL';
		IF InputRoot.XMLNSC.*:firmarXmlResponse.xmlFirmado = '' THEN
			THROW USER EXCEPTION MESSAGE(3) VALUES('Error al firmar el mensaje (respuesta vacía)');
		ELSEIF InputRoot.XMLNSC.*:validateXmlSignResponse.isValid = 'false' THEN
			THROW USER EXCEPTION MESSAGE(1) VALUES('La firma del mensaje no es válida (respuesta false)');
		END IF;
		SET OutputRoot.MQMD = Environment.MQMD;
		SET OutputRoot.XMLNSC = InputRoot.XMLNSC;
		SET OutputRoot.XMLNSC.[1].DetalleTransaccion = Environment.DetalleTransaccion;
		SET OutputLocalEnvironment.Destination.MQ.DestinationData.queueName = Environment.MQMD.ReplyToQ;
		RETURN TRUE;
	END;
END MODULE;