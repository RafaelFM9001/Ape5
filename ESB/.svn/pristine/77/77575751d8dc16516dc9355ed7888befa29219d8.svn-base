BROKER SCHEMA mx.gob.sat.matce

/*
*
* Autor: Oscar Daniel Jiménez Gutiérrez - Softtek
* Fecha de creación: 17 Enero 2018 Version: 1.0
*/

--Variable para configuración de la ruta de esquemas XSD, el valor lo obtiene de las variables del flujo (editor gráfico)
DECLARE NoNamespaceSchemaLocation EXTERNAL CHARACTER '';

CREATE COMPUTE MODULE FilterXML_InitializeFlowWS
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		SET Environment.XMLValidator.NoNamespaceSchemaLocation = NoNamespaceSchemaLocation;
		DECLARE refEnv REFERENCE TO Environment;
		DECLARE refIn REFERENCE TO InputRoot;
		CALL InitializeFlowWS(refEnv, refIn);
		SET OutputRoot.XMLNSC = InputRoot.XMLNSC;
		RETURN TRUE;
	END;
END MODULE;

CREATE COMPUTE MODULE FilterXML
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		SET OutputRoot.XMLNSC = InputRoot.XMLNSC;
		IF EXISTS(InputRoot.XMLNSC.Error[]) THEN
			PROPAGATE TO TERMINAL 'out4';
		ELSE
			RETURN TRUE;
		END IF;
		RETURN FALSE;		
	END;
END MODULE;


CREATE PROCEDURE InitializeFlowWS(
INOUT refEnv REFERENCE,
INOUT refIn REFERENCE)
BEGIN
		SET refEnv.DetalleTransaccion = refIn.XMLNSC.[1].DetalleTransaccion;
		SET refEnv.DetalleTransaccion.servicio = FIELDNAME(refIn.XMLNSC.[1]);
		SET refEnv.DetalleTransaccion.lc = refIn.XMLNSC.*.lc;
		SET refEnv.DetalleTransaccion.timestampTransaccion = CURRENT_TIMESTAMP;

		SET refEnv.Broker.BrokerName = BrokerName;
		SET refEnv.Broker.ExecutionGroupLabel = ExecutionGroupLabel;
		SET refEnv.Broker.MessageFlowLabel = MessageFlowLabel;
END;